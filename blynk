#define BLYNK_TEMPLATE_ID   "TMPLxxxxxx"
#define BLYNK_TEMPLATE_NAME "SmartHomeESP32"
#define BLYNK_AUTH_TOKEN    "Token_Blynk_Anda"

#include <WiFi.h>
#include <BlynkSimpleEsp32.h>
#include <DHT.h>
#include <ESP32Servo.h>

// Konfigurasi WiFi
char ssid[] = "Nama_WiFi";
char pass[] = "Password_WiFi";

// Definisi Pin sesuai rangkaian Anda
#define DHTPIN 2          //
#define DHTTYPE DHT11
#define RELAY_PIN 13      //
#define TRIG_PIN 9        //
#define ECHO_PIN 8        //
#define SERVO_PIN 5       // Pin PWM untuk Servo

DHT dht(DHTPIN, DHTTYPE);
Servo pintuServo;
BlynkTimer timer;

// Fungsi Manual: Kontrol Relay Lampu (Button V3)
BLYNK_WRITE(V3) {
  digitalWrite(RELAY_PIN, param.asInt());
}

// Fungsi Manual: Buka/Tutup Pintu (Button V4)
BLYNK_WRITE(V4) {
  if (param.asInt() == 1) bukaPintu();
  else tutupPintu();
}

void bukaPintu() {
  pintuServo.write(90); 
  Blynk.virtualWrite(V4, 1);
  Serial.println("Pintu Dibuka");
}

void tutupPintu() {
  pintuServo.write(0);
  Blynk.virtualWrite(V4, 0);
  Serial.println("Pintu Ditutup");
}

void updateSistem() {
  // 1. Baca Sensor Lingkungan
  float t = dht.readTemperature();
  float h = dht.readHumidity();
  
  // 2. Baca Jarak Ultrasonik
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);
  long durasi = pulseIn(ECHO_PIN, HIGH);
  int jarak = durasi * 0.034 / 2;

  // 3. Logika Pintu Otomatis (Jika jarak < 30 cm)
  if (jarak > 0 && jarak < 30) {
    bukaPintu();
    // Pintu akan menutup otomatis setelah 3 detik jika tidak ada objek
  }

  // 4. Kirim Data ke Dashboard Blynk
  Blynk.virtualWrite(V0, t);     // Suhu
  Blynk.virtualWrite(V1, h);     // Kelembapan
  Blynk.virtualWrite(V2, jarak); // Jarak
  
  // Tampilkan di Serial Monitor untuk Debugging
  Serial.printf("Suhu: %.1f, Jarak: %d cm\n", t, jarak);
}

void setup() {
  Serial.begin(115200);
  pinMode(RELAY_PIN, OUTPUT);
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  
  dht.begin();
  pintuServo.attach(SERVO_PIN);
  
  Blynk.begin(BLYNK_AUTH_TOKEN, ssid, pass);
  
  // Update data setiap 2 detik
  timer.setInterval(2000L, updateSistem);
}

void loop() {
  Blynk.run();
  timer.run();
}
